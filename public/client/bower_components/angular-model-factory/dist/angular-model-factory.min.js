/**
 * modelFactory makes working with RESTful APIs in AngularJS easy
 * @version v1.0.3 - 2015-11-09
 * @link http://swimlane.github.io/angular-model-factory/
 * @author Austin McDaniel <amcdaniel2@gmail.com>, Juri Strumpflohner <juri.strumpflohner@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";!function(a,b){"function"==typeof define&&define.amd?define(["angular","uri-templates","deep-diff"],b):"undefined"!=typeof module&&module.exports?module.exports=b(require("angular"),require("uri-templates"),require("deep-diff")):a.ModelFactory=b(a.angular,a.UriTemplate,a.DeepDiff)}(this,function(a,b,c){var d=a.module("modelFactory",[]),e=a.forEach,f=a.extend,g=a.copy,h=["$$array","$save","$destroy","$pending","$rollback","$diff","$update","$commit","$copy"],i=["actions","instance","list","defaults","pk","stripTrailingSlashes","map"],j=function(b){return e(arguments,function(c){c!==b&&e(c,function(c,d){-1===h.indexOf(d)&&(b[d]?a.isArray(b[d])?b[d].concat(c.filter(function(a){var c=-1!==b[d].indexOf(a);return c&&j(c,a),c})):a.isObject(b[d])?j(b[d],c):b[d]=c:a.isFunction(b[d])||(b[d]=c))})}),b},k=function(b,c){c=c||{},e(c,function(a,d){b.hasOwnProperty(d)||"$"===d.charAt(0)||delete c[d]});for(var d in b)b.hasOwnProperty(d)&&"$"!==d.charAt(0)&&(a.isObject(b[d])&&!a.isArray(b[d])?c[d]=k(b[d],c[d]):c[d]=b[d]);return c};return d.provider("$modelFactory",function(){var d=this;d.defaultOptions={prefix:"",pk:"id",stripTrailingSlashes:!0,defaults:{},map:{},actions:{base:{wrap:!0,beforeRequest:void 0,afterRequest:void 0,cache:!1},get:{method:"GET"},query:{method:"GET",isArray:!0},post:{method:"POST",invalidateCache:!0},update:{method:"PUT",invalidateCache:!0},"delete":{method:"DELETE",invalidateCache:!0}},instance:{},list:{}},d.$get=["$rootScope","$http","$q","$log","$cacheFactory",function(l,m,n,o,p){function q(o,q){function r(a){a=a||[],a.forEach(function(b,c){null!==b&&void 0!==b&&(a[c]=w(b,a))});var b=a.push;return a.push=function(){for(var c=Array.prototype.slice.call(arguments),d=0;d<c.length;d++)c[d]=w(c[d],a);b.apply(a,c)},q.list&&f(a,q.list),a}function s(b){var d=this,h=[];b=b||{},e(q.defaults,function(a,c){void 0===b[c]&&("function"==typeof a?b[c]=g(a(b)):b[c]=g(a))}),e(q.map,function(a,c){x(a)===x(s)||x(a)===x(r)?b[c]=new a(b[c]):"function"==typeof a?b[c]=a(b[c],b):(b[c]=b[a],delete b[a])}),e(q.actions,function(a,b){"$"===b[0]&&(d[b]=function(){return s.$buildRequest(b,a,d)})}),f(d,b),f(d,g(q.instance)),d.$save=function(){var b=d[q.pk]?"update":"post",c=s[b](this);return d.$pending=!0,c.then(function(c){d.$pending=!1,c&&d.$update(c);var e="post"===b?"created":"updated";l.$broadcast(v+"-"+e,d),h.push(a.toJson(d))},function(){d.$pending=!1}),c},d.$destroy=function(){var a=s["delete"](this);return d.$pending=!0,a.then(function(){d.$pending=!1;var a=d.$$array;a&&a.splice(a.indexOf(d),1),l.$broadcast(v+"-destroyed",d)},function(){d.$pending=!1}),a},d.$diff=function(b){var e=h[b||h.length-1],f=a.toJson(d);return c.diff(JSON.parse(e),JSON.parse(f),function(a,b){return"$"===b[0]})},d.$commit=function(){return h.push(a.toJson(d)),d},d.$rollback=function(a){var b=h[a||h.length-1];return d.$update(JSON.parse(b)),d},d.$update=function(a){return k(a,d),d},d.$copy=function(){var b=a.toJson(this);return new s(a.fromJson(b))},d.$commit()}var t={},u=o.split("/"),v=u[u.length-1];q=j({},g(d.defaultOptions),q);var w=function(a,b){var c=a.constructor===s?a:new s(a);return c.$$array=b,c},x=function(a){var b=a.toString();return b=b.substr("function ".length),b=b.substr(0,b.indexOf("("))};return s.$cache=p(o),e(q.actions,function(a,b){"base"!==b&&"$"!==b[0]&&(s[b]=function(){var c=Array.prototype.slice.call(arguments);return s.$buildRequest.apply(this,[b,a].concat(c))})}),s.$buildRequest=function(b,c,d,e){var h=g(q.actions.base);f(h,g(c)),h.cache===!0&&(h.cache=s.$cache),h.method=h.method||"GET";var i=q.prefix?q.prefix+"/":"";if(h.override)i=h.url;else if(i+=o,h.url&&(i+="/"+h.url),i=s.$url(i,d,h.method),("get"===b||"post"===b||"update"===b||"delete"===b)&&(i+="/{"+q.pk+"}"),"GET"===h.method&&(a.isString(d)||a.isNumber(d))){var k={};k[q.pk]=d,d=k,e&&(h.params=j({},h.params,e))}else"GET"===h.method&&a.isObject(d)&&(h.params=j({},h.params,d));return h.url=s.$url(i,d,h.method),"delete"!==b&&"DELETE"!==h.method&&(h.data=d),s.$call(h)},s.$call=function(a){var b=a.method+":"+a.url;if(t[b])return t[b];var c=n.defer();return t[b]=c.promise,a.data=g(a.data),a.beforeRequest&&a.beforeRequest(a),a.data=s.$strip(a.data),m(a).then(function(b){if(a.afterRequest){var d=a.afterRequest(b.data);d&&(b.data=d)}a.invalidateCache&&s.$cache.removeAll(),b?a.wrap?a.isArray?c.resolve(new s.List(b.data)):c.resolve(new s(b.data)):c.resolve(b.data):c.resolve()},c.reject)["finally"](function(){t[b]=void 0}),c.promise},s.$url=function(a,c,d){var e=new b(a||o).fill(function(a){var b=c[a];return b?("GET"===d&&delete c[a],b):null});return q.stripTrailingSlashes&&(e=e.replace(/\/+$/,"")||"/"),e},s.$strip=function(a){return a&&"object"==typeof a&&e(a,function(b,c){h.indexOf(c)>-1&&delete a[c]}),a},e(q,function(a,b){-1===i.indexOf(b)&&(s[b]=a)}),s.List=r,s}return q}]}),d});